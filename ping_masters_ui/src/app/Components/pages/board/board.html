<div class="board-page">

    <!-- Top Bar -->
    <header class="board-header flex items-center justify-between px-8 py-3">
        <span class="text-xl font-semibold text-gray-800 tracking-tight">Ping Masters</span>
        <div class="flex items-center gap-2">
            <button class="text-sm text-gray-600 px-4 py-2 rounded-full hover:bg-gray-100 transition-colors duration-150 font-medium"
                (click)="navigateToBorrow()">
                Borrow
            </button>
            <button class="text-sm text-gray-600 px-4 py-2 rounded-full hover:bg-gray-100 transition-colors duration-150 font-medium">
                Profile
            </button>
            <button class="text-sm text-gray-600 px-4 py-2 rounded-full hover:bg-gray-100 transition-colors duration-150 font-medium"
                (click)="signOut()">
                Sign out
            </button>
            <app-navbar></app-navbar>
        </div>
    </header>

    <!-- Main Content -->
    <main class="board-main flex gap-6 px-8 py-6">

        <!-- Left Column -->
        <div class="flex flex-col gap-5 flex-1 min-w-0">

            <!-- User Card -->
            <div class="flex items-center gap-4 bg-white rounded-2xl px-6 py-4 board-card">
                @if (user(); as currentUser) {
                    <div class="flex items-center justify-center rounded-full bg-blue-600 text-white text-lg font-semibold w-11 h-11 shrink-0 overflow-hidden">
                        @if (currentUser.photoURL) {
                            <img class="w-full h-full object-cover" [src]="currentUser.photoURL" alt="" referrerpolicy="no-referrer" />
                        } @else {
                            {{ (currentUser.displayName || currentUser.email || '...')[0].toUpperCase() }}
                        }
                    </div>
                    <div class="flex flex-col">
                        <span class="text-sm font-semibold text-gray-800">{{ currentUser.displayName || 'User' }}</span>
                        <span class="text-xs text-gray-400 mt-0.5">{{ currentUser.email || 'No email linked' }}</span>
                    </div>
                } @else {
                    <div class="flex items-center justify-center rounded-full bg-blue-600 text-white text-lg font-semibold w-11 h-11 shrink-0">
                        ...
                    </div>
                    <div class="flex flex-col">
                        <span class="text-sm font-semibold text-gray-800">Loading profile...</span>
                        <span class="text-xs text-gray-400 mt-0.5">&nbsp;</span>
                    </div>
                }
            </div>

            <!-- History Section -->
            <div class="board-card bg-white rounded-2xl overflow-hidden">
                <div class="flex items-center justify-between px-6 py-4 border-b border-gray-100">
                    <span class="text-xs font-semibold text-gray-500 uppercase tracking-widest">History</span>
                    <div class="flex items-center gap-3">
                        <span class="text-xs text-gray-400">Latest first</span>
                        <span class="text-xs text-gray-400">{{ historyItems().length }} entries</span>
                    </div>
                </div>
                <div *ngIf="loading()" class="px-6 py-4 text-xs text-gray-400">Loading history...</div>
                <div *ngIf="!loading() && historyItems().length === 0" class="px-6 py-4 text-xs text-gray-400">No history events yet.</div>
                <div class="history-list-scroll">
                    <div class="flex flex-col gap-1 p-3">
                        @for (item of pagedHistoryItems(); track item.id) {
                            <app-history-item
                                [title]="item.title"
                                [amount]="item.amount"
                                [status]="item.status"
                                (itemClicked)="goToLoan(item.loanId)">
                            </app-history-item>
                        }
                    </div>
                </div>
                @if (!loading() && historyItems().length > 0) {
                    <div class="history-pagination border-t border-gray-100 px-6 py-3 flex items-center justify-between">
                        <button
                            type="button"
                            class="history-page-btn"
                            [disabled]="!canGoPreviousHistoryPage()"
                            (click)="previousHistoryPage()">
                            Previous
                        </button>
                        <span class="text-xs text-gray-500">
                            Page {{ historyCurrentPage() }} / {{ historyTotalPages() }}
                        </span>
                        <button
                            type="button"
                            class="history-page-btn"
                            [disabled]="!canGoNextHistoryPage()"
                            (click)="nextHistoryPage()">
                            Next
                        </button>
                    </div>
                }
            </div>

        </div>

        <!-- Right Column -->
        <div class="flex flex-col gap-5 w-72 shrink-0">

            <!-- Wallets Section -->
            <div class="board-card bg-white rounded-2xl overflow-hidden">
                <div class="flex items-center justify-between px-6 py-4 border-b border-gray-100">
                    <span class="text-xs font-semibold text-gray-500 uppercase tracking-widest">Wallets</span>
                    <button
                        class="text-xs text-blue-600 hover:text-blue-800 transition-colors duration-150 font-semibold"
                        type="button"
                        (click)="toggleWalletEditor()">
                        {{ walletEditorOpen() ? 'Close' : '+ Add' }}
                    </button>
                </div>
                <div *ngIf="loading()" class="px-6 py-4 text-xs text-gray-400">Loading wallets...</div>
                <div *ngIf="!loading() && wallets().length === 0" class="px-6 py-4 text-xs text-gray-400">No wallets found for this user.</div>
                <div class="flex flex-col gap-1 p-3">
                    @for (wallet of wallets(); track wallet.wallet_id) {
                        <app-wallet-item [wallet]="wallet" (deleteWallet)="removeWallet(wallet.wallet_id)"></app-wallet-item>
                    }
                </div>

                @if (walletError(); as message) {
                    <div class="px-6 pb-4 text-xs text-red-600">{{ message }}</div>
                }

                @if (walletEditorOpen()) {
                    <div class="px-6 pb-4 flex flex-col gap-2">
                        <input
                            class="w-full rounded-xl border border-gray-200 px-4 py-2 text-sm outline-none focus:border-blue-400"
                            type="text"
                            placeholder="Wallet name (e.g. Metamask)"
                            [value]="walletNameInput()"
                            (input)="walletNameInput.set($any($event.target).value)" />
                        <input
                            class="w-full rounded-xl border border-gray-200 px-4 py-2 text-sm outline-none focus:border-blue-400"
                            type="text"
                            placeholder="Wallet address (e.g. 0xabc123...)"
                            [value]="walletIdInput()"
                            (input)="walletIdInput.set($any($event.target).value)" />
                    </div>
                }

                @if (walletEditorOpen() || walletDirty()) {
                    <div class="px-6 py-4 border-t border-gray-100 flex items-center justify-between">
                        <span class="text-xs text-gray-400">
                            @if (walletDirty()) { Unsaved changes }
                        </span>
                        <button
                            class="text-xs font-semibold text-white bg-blue-600 hover:bg-blue-700 transition-colors duration-150 px-4 py-2 rounded-full disabled:opacity-50 disabled:cursor-not-allowed"
                            type="button"
                            [disabled]="walletSaving() || (!walletDirty() && !walletNameInput().trim() && !walletIdInput().trim())"
                            (click)="submitWalletChanges()">
                            {{ walletSaving() ? 'Saving...' : 'Submit' }}
                        </button>
                    </div>
                }
            </div>

        </div>

    </main>

</div>
